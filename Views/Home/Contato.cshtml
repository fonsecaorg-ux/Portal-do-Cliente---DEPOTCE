@{
    ViewData["Title"] = "Fale com a Depotce";
    var whatsappNumero = ViewBag.WhatsAppNumero as string ?? "";
    var email          = ViewBag.Email as string ?? "";
    var nomeEquipe     = ViewBag.NomeEquipe as string ?? "Depotce";
    var codigoPre      = ViewBag.CodigoPre as string ?? "";
    var isotanque      = ViewBag.Isotanque as PortalCliente.Models.Container;
}

<nav aria-label="breadcrumb" class="mb-3">
    <ol class="breadcrumb">
        @if (User.Identity?.IsAuthenticated == true)
        {
            <li class="breadcrumb-item"><a asp-action="Index">Isotanques</a></li>
            @if (isotanque != null)
            {
                <li class="breadcrumb-item"><a asp-action="Detalhe" asp-route-codigo="@isotanque.Codigo">@isotanque.Codigo</a></li>
            }
        }
        else
        {
            <li class="breadcrumb-item"><a asp-controller="Conta" asp-action="Login">Entrar</a></li>
        }
        <li class="breadcrumb-item active">Fale com a Depotce</li>
    </ol>
</nav>

<div class="row mb-4">
    <div class="col">
        <h1 class="display-6 mb-1">Fale com a Depotce</h1>
        <p class="text-muted">Nossa equipe responde em horário comercial. Para urgências, use o WhatsApp.</p>
        @if (User.Identity?.IsAuthenticated != true)
        {
            <div class="alert alert-info py-2 mt-2 mb-0 small">
                <strong>Esqueceu sua senha?</strong> Envie uma mensagem abaixo (por e-mail ou WhatsApp) solicitando a redefinição. Nossa equipe tratará o pedido em breve.
            </div>
        }
    </div>
</div>

@if (isotanque != null)
{
    <div class="alert d-flex align-items-center gap-3 mb-4" style="background:#f0f4ff; border:1px solid #c7d4f0; border-radius:8px;">
        <div>
            <div class="small text-muted mb-1">ISOTANQUE SELECIONADO</div>
            <span class="font-monospace fw-bold fs-5">@isotanque.Codigo</span>
            <span class="ms-2 text-muted">@isotanque.Produto</span>
            <span class="ms-3 badge status-badge-@isotanque.Status.ToLower().Replace(" ", "-").Replace(".", "")">@isotanque.Status</span>
            @if (isotanque.DiasNoStatus.HasValue)
            {
                <span class="ms-2 badge @(isotanque.DiasNoStatus >= 15 ? "bg-danger" : isotanque.DiasNoStatus >= 8 ? "bg-warning text-dark" : "bg-success")">
                    @isotanque.DiasNoStatus dias
                </span>
            }
        </div>
    </div>
}

<div class="row g-4">
    <!-- Formulário -->
    <div class="col-lg-7">
        <div class="card border-0 shadow-sm">
            <div class="card-body p-4">
                <h5 class="fw-semibold mb-4">Monte sua mensagem</h5>

                <div class="mb-3">
                    <label class="form-label small text-muted text-uppercase" style="letter-spacing:.05em">Isotanque</label>
                    <input type="text" id="inputCodigo" class="form-control font-monospace"
                           placeholder="Ex: DHDU1274480" value="@codigoPre" maxlength="20" />
                    <div class="form-text">Deixe em branco para uma dúvida geral.</div>
                </div>

                <div class="mb-3">
                    <label class="form-label small text-muted text-uppercase" style="letter-spacing:.05em">Assunto</label>
                    <div class="d-flex flex-wrap gap-2" id="assuntoGroup">
                        @foreach (var op in new[] { "Prazo de liberação", "Documentação", "Vistoria / Laudo", "Reparo", "Outro" })
                        {
                            <button type="button"
                                    class="btn btn-sm btn-outline-secondary assunto-btn"
                                    data-assunto="@op">
                                @op
                            </button>
                        }
                    </div>
                    <input type="hidden" id="inputAssunto" value="" />
                </div>

                <div class="mb-4">
                    <label class="form-label small text-muted text-uppercase" style="letter-spacing:.05em">
                        Mensagem <span class="text-muted fw-normal">(opcional)</span>
                    </label>
                    <textarea id="inputMensagem" class="form-control" rows="3"
                              placeholder="Descreva sua dúvida ou situação..."></textarea>
                </div>

                <!-- Preview da mensagem -->
                <div class="mb-4 p-3 rounded" style="background:#f8f9fa; border:1px solid #e9ecef;">
                    <div class="small text-muted mb-2 text-uppercase" style="letter-spacing:.05em">Prévia da mensagem</div>
                    <div id="previewMensagem" class="small" style="white-space:pre-line; color:#333;"></div>
                </div>

                <!-- Botões de envio -->
                <div class="d-flex flex-wrap gap-3">
                    @if (!string.IsNullOrWhiteSpace(whatsappNumero))
                    {
                        <a id="btnWhatsApp"
                           href="#"
                           target="_blank"
                           class="btn btn-depotce d-flex align-items-center gap-2 px-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M13.601 2.326A7.85 7.85 0 0 0 7.994 0C3.627 0 .068 3.558.064 7.926c0 1.399.366 2.76 1.057 3.965L0 16l4.204-1.102a7.9 7.9 0 0 0 3.79.965h.004c4.368 0 7.926-3.558 7.93-7.93A7.9 7.9 0 0 0 13.6 2.326zM7.994 14.521a6.6 6.6 0 0 1-3.356-.92l-.24-.144-2.494.654.666-2.433-.156-.251a6.56 6.56 0 0 1-1.007-3.505c0-3.626 2.957-6.584 6.591-6.584a6.56 6.56 0 0 1 4.66 1.931 6.56 6.56 0 0 1 1.928 4.66c-.004 3.639-2.961 6.592-6.592 6.592m3.615-4.934c-.197-.099-1.17-.578-1.353-.646-.182-.065-.315-.099-.445.099-.133.197-.513.646-.627.775-.114.133-.232.148-.43.05-.197-.1-.836-.308-1.592-.985-.59-.525-.985-1.175-1.103-1.372-.114-.198-.011-.304.088-.403.087-.088.197-.232.296-.346.1-.114.133-.198.198-.33.065-.134.034-.248-.015-.347-.05-.099-.445-1.076-.612-1.47-.16-.389-.323-.335-.445-.34-.114-.007-.247-.007-.38-.007a.73.73 0 0 0-.529.247c-.182.198-.691.677-.691 1.654s.71 1.916.81 2.049c.098.133 1.394 2.132 3.383 2.992.47.205.84.326 1.129.418.475.152.904.129 1.246.08.38-.058 1.171-.48 1.338-.943.164-.464.164-.86.114-.943-.049-.084-.182-.133-.38-.232"/>
                            </svg>
                            Enviar pelo WhatsApp
                        </a>
                    }
                    @if (!string.IsNullOrWhiteSpace(email))
                    {
                        <a id="btnEmail"
                           href="#"
                           class="btn btn-outline-depotce d-flex align-items-center gap-2 px-4">
                            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" fill="currentColor" viewBox="0 0 16 16">
                                <path d="M0 4a2 2 0 0 1 2-2h12a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H2a2 2 0 0 1-2-2zm2-1a1 1 0 0 0-1 1v.217l7 4.2 7-4.2V4a1 1 0 0 0-1-1zm13 2.383-4.708 2.825L15 11.105zm-.034 6.876-5.64-3.471L8 9.583l-1.326-.795-5.64 3.47A1 1 0 0 0 2 13h12a1 1 0 0 0 .966-.741M1 11.105l4.708-2.897L1 5.383z"/>
                            </svg>
                            Enviar por E-mail
                        </a>
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- Info lateral -->
    <div class="col-lg-5">
        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body p-4">
                <h6 class="fw-semibold mb-3">Como funciona</h6>
                <div class="d-flex gap-3 mb-3">
                    <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0"
                         style="width:32px;height:32px;background:#8B1C1C;color:white;font-size:.8rem;font-weight:700;">1</div>
                    <div class="small text-muted">Selecione o isotanque e o assunto da sua solicitação.</div>
                </div>
                <div class="d-flex gap-3 mb-3">
                    <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0"
                         style="width:32px;height:32px;background:#8B1C1C;color:white;font-size:.8rem;font-weight:700;">2</div>
                    <div class="small text-muted">Adicione detalhes opcionais na mensagem.</div>
                </div>
                <div class="d-flex gap-3">
                    <div class="rounded-circle d-flex align-items-center justify-content-center flex-shrink-0"
                         style="width:32px;height:32px;background:#8B1C1C;color:white;font-size:.8rem;font-weight:700;">3</div>
                    <div class="small text-muted">Clique em WhatsApp ou E-mail — a mensagem já vai preenchida para a @nomeEquipe.</div>
                </div>
            </div>
        </div>

        <div class="card border-0 shadow-sm mb-3">
            <div class="card-body p-4">
                <h6 class="fw-semibold mb-3">Horário de atendimento</h6>
                <div class="small text-muted">
                    <div class="d-flex justify-content-between mb-1">
                        <span>Segunda a Sexta</span><span class="fw-semibold text-dark">08h – 18h</span>
                    </div>
                    <div class="d-flex justify-content-between">
                        <span>Sábado</span><span class="fw-semibold text-dark">08h – 12h</span>
                    </div>
                </div>
            </div>
        </div>

        @if (!string.IsNullOrWhiteSpace(whatsappNumero))
        {
            <div class="card border-0 shadow-sm" style="border-left:3px solid #25D366 !important;">
                <div class="card-body p-4">
                    <div class="small text-muted mb-1">URGÊNCIAS</div>
                    <div class="small">Para situações urgentes, o WhatsApp é o canal mais rápido.</div>
                </div>
            </div>
        }
    </div>
</div>

@section Scripts {
<script>
    const whatsappNumero = "@whatsappNumero";
    const emailDestino   = "@email";
    const nomeEquipe     = "@nomeEquipe";

    let assuntoSelecionado = "";

    // Seleção de assunto
    document.querySelectorAll(".assunto-btn").forEach(btn => {
        btn.addEventListener("click", () => {
            document.querySelectorAll(".assunto-btn").forEach(b => {
                b.classList.remove("btn-depotce");
                b.classList.add("btn-outline-secondary");
            });
            btn.classList.remove("btn-outline-secondary");
            btn.classList.add("btn-depotce");
            assuntoSelecionado = btn.dataset.assunto;
            document.getElementById("inputAssunto").value = assuntoSelecionado;
            atualizarPreview();
        });
    });

    document.getElementById("inputCodigo").addEventListener("input", atualizarPreview);
    document.getElementById("inputMensagem").addEventListener("input", atualizarPreview);

    function montarMensagem() {
        const codigo   = document.getElementById("inputCodigo").value.trim().toUpperCase();
        const mensagem = document.getElementById("inputMensagem").value.trim();

        let texto = `Olá, ${nomeEquipe}!`;
        if (codigo)   texto += `\n\nIsotanque: *${codigo}*`;
        if (assuntoSelecionado) texto += `\nAssunto: *${assuntoSelecionado}*`;
        if (mensagem) texto += `\n\n${mensagem}`;
        if (!codigo && !assuntoSelecionado && !mensagem) texto += `\n\nGostaria de obter informações.`;

        return texto;
    }

    function atualizarPreview() {
        document.getElementById("previewMensagem").textContent = montarMensagem();
        atualizarLinks();
    }

    function atualizarLinks() {
        const msg = montarMensagem();

        // WhatsApp
        const btnWa = document.getElementById("btnWhatsApp");
        if (btnWa) {
            btnWa.href = `https://wa.me/${whatsappNumero}?text=${encodeURIComponent(msg)}`;
        }

        // Email
        const btnEmail = document.getElementById("btnEmail");
        if (btnEmail) {
            const codigo  = document.getElementById("inputCodigo").value.trim().toUpperCase();
            const subject = codigo
                ? `[Portal Depotce] ${assuntoSelecionado || "Solicitação"} – ${codigo}`
                : `[Portal Depotce] ${assuntoSelecionado || "Solicitação"}`;
            btnEmail.href = `mailto:${emailDestino}?subject=${encodeURIComponent(subject)}&body=${encodeURIComponent(msg)}`;
        }
    }

    // Inicializa preview
    atualizarPreview();
</script>
}
